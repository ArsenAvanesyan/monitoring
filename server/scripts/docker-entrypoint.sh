#!/bin/sh
# Entrypoint —Å–∫—Ä–∏–ø—Ç –¥–ª—è backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –°–æ–∑–¥–∞–µ—Ç –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ), –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ) –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

set -e

echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ PostgreSQL..."
node scripts/wait-for-postgres.js

echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ Redis..."
node scripts/wait-for-redis.js

# –°–æ–∑–¥–∞–µ–º –ë–î, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
node scripts/create-db.js

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
if [ "$SKIP_MIGRATIONS" != "true" ]; then
  echo "üì¶ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
  npx sequelize db:migrate
  echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
else
  echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π (SKIP_MIGRATIONS=true)"
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
exec node src/app.js

