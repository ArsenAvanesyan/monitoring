#!/bin/sh
# Pre-push hook: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ push

set -e

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–∏—â–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å client/ –∏ server)
PROJECT_ROOT="$(pwd)"
while [ "$PROJECT_ROOT" != "/" ]; do
    if [ -d "$PROJECT_ROOT/client" ] && [ -d "$PROJECT_ROOT/server" ]; then
        break
    fi
    PROJECT_ROOT="$(dirname "$PROJECT_ROOT")"
done

if [ "$PROJECT_ROOT" = "/" ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å client/ –∏ server/)" >&2
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_ROOT"

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ –ø–µ—Ä–µ–¥ push..."
echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PROJECT_ROOT"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏
error() {
    echo "‚ùå $1" >&2
    exit 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —É—Å–ø–µ—Ö–∞
success() {
    echo "‚úÖ $1"
}

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Frontend
echo ""
echo "üì¶ –°–±–æ—Ä–∫–∞ Frontend..."
cd "$PROJECT_ROOT/client"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ node_modules, –µ—Å–ª–∏ –Ω–µ—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
if [ ! -d "node_modules" ]; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
    npm install
fi

# –°–æ–±–∏—Ä–∞–µ–º frontend
if npm run build 2>&1; then
    success "Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å rollup - –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if npm run build 2>&1 | grep -q "rollup\|MODULE_NOT_FOUND"; then
        echo "üîÑ –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        rm -rf node_modules package-lock.json
        npm install
        if npm run build; then
            success "Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏"
        else
            error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Frontend. Push –æ—Ç–º–µ–Ω—ë–Ω."
        fi
    else
        error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Frontend. Push –æ—Ç–º–µ–Ω—ë–Ω."
    fi
fi

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Backend
echo ""
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ Backend..."
cd "$PROJECT_ROOT/server"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ node_modules, –µ—Å–ª–∏ –Ω–µ—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
if [ ! -d "node_modules" ]; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
    npm install
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö JS —Ñ–∞–π–ª–æ–≤ –≤ src/
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Ñ–∞–π–ª–æ–≤..."
SYNTAX_ERRORS=0
for file in $(find src -name "*.js" -type f); do
    if ! node -c "$file" 2>/dev/null; then
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ $file"
        SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
    fi
done

if [ $SYNTAX_ERRORS -eq 0 ]; then
    success "–°–∏–Ω—Ç–∞–∫—Å–∏—Å Backend –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $(find src -name "*.js" -type f | wc -l | tr -d ' '))"
else
    error "–ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ Backend: $SYNTAX_ERRORS. Push –æ—Ç–º–µ–Ω—ë–Ω."
fi

cd "$PROJECT_ROOT"

echo ""
success "–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! Push —Ä–∞–∑—Ä–µ—à—ë–Ω."
exit 0
