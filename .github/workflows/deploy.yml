name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/monitoring-frontend:latest,${{ env.DOCKERHUB_USERNAME }}/monitoring-frontend:${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/monitoring-frontend:latest
          cache-to: type=inline

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/monitoring-backend:latest,${{ env.DOCKERHUB_USERNAME }}/monitoring-backend:${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/monitoring-backend:latest
          cache-to: type=inline

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ env.SSH_PORT }} ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Create backup of current images
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
            docker images --format "{{.Repository}}:{{.Tag}}" | grep "monitoring-frontend\|monitoring-backend" | while read image; do
              if [ "$image" != "${{ env.DOCKERHUB_USERNAME }}/monitoring-frontend:latest" ] && [ "$image" != "${{ env.DOCKERHUB_USERNAME }}/monitoring-backend:latest" ]; then
                docker tag "$image" "${image}-backup-$(date +%Y%m%d-%H%M%S)" || true
              fi
            done
          EOF

      - name: Pull new images
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹..."
            DOCKERHUB_USERNAME="${{ env.DOCKERHUB_USERNAME }}" \
            docker compose pull frontend backend || exit 1
          EOF

      - name: Stop old containers
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            DOCKERHUB_USERNAME="${{ env.DOCKERHUB_USERNAME }}" \
            docker compose stop frontend backend || true
          EOF

      - name: Start new containers
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            DOCKERHUB_USERNAME="${{ env.DOCKERHUB_USERNAME }}" \
            POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
            POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            POSTGRES_DB="${{ secrets.POSTGRES_DB }}" \
            ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
            REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            CLIENT_URL="${{ secrets.CLIENT_URL }}" \
            DOMAIN="${{ secrets.DOMAIN }}" \
            EMAIL="${{ secrets.EMAIL }}" \
            docker compose up -d --no-deps frontend backend || exit 1
          EOF

      - name: Wait for health check
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "â³ Ð–Ð´Ñ‘Ð¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (30 ÑÐµÐºÑƒÐ½Ð´)..."
            sleep 30
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
            if ! docker compose ps | grep -q "frontend.*Up\|backend.*Up"; then
              echo "âŒ ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ!"
              exit 1
            fi
            
            echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
          EOF

      - name: Cleanup old images
        if: success()
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (ÐºÑ€Ð¾Ð¼Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 3 Ð²ÐµÑ€ÑÐ¸Ð¹)..."
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹, Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3 Ð²ÐµÑ€ÑÐ¸Ð¸
            docker images --format "{{.Repository}}:{{.Tag}}" | \
              grep "monitoring-frontend\|monitoring-backend" | \
              grep -v "latest" | \
              grep -v "backup" | \
              sort -r | \
              tail -n +4 | \
              xargs -r docker rmi -f || true
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ backup Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (ÑÑ‚Ð°Ñ€ÑˆÐµ 7 Ð´Ð½ÐµÐ¹)
            docker images --format "{{.Repository}}:{{.Tag}} {{.CreatedAt}}" | \
              grep "backup" | \
              awk -v cutoff="$(date -d '7 days ago' +%Y-%m-%d)" '$2 < cutoff {print $1}' | \
              xargs -r docker rmi -f || true
            
            # ÐžÐ±Ñ‰Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
            docker image prune -f || true
            
            echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ”„ ÐžÑ‚ÐºÐ°Ñ‚ Ðº Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸..."
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            docker compose stop frontend backend || true
            docker compose rm -f frontend backend || true
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ (docker compose up Ð¿Ð¾Ð´Ñ‚ÑÐ½ÐµÑ‚ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹)
            DOCKERHUB_USERNAME="${{ env.DOCKERHUB_USERNAME }}" \
            POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
            POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            POSTGRES_DB="${{ secrets.POSTGRES_DB }}" \
            ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
            REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            CLIENT_URL="${{ secrets.CLIENT_URL }}" \
            DOMAIN="${{ secrets.DOMAIN }}" \
            EMAIL="${{ secrets.EMAIL }}" \
            docker compose up -d frontend backend || true
            
            echo "âš ï¸ ÐžÑ‚ÐºÐ°Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ - ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
          EOF
